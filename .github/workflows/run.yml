name: run-opthub-automation

on:
  workflow_dispatch:
  schedule:
    - cron: "0 12 * * *" # executa todos os dias às 09:00 (UTC-3)

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # ========================
      # 1️⃣ Preparação do ambiente
      # ========================
      - name: Set up job
        run: echo "Iniciando rotina automática de moderação de clientes..."

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || echo "requirements.txt não encontrado, prosseguindo..."

      # ========================
      # 2️⃣ Rodar main.py (gera StatusModeration)
      # ========================
      - name: Rodar main.py (gera StatusModeration)
        run: |
          if [ -f "src/main.py" ]; then
            echo "Executando src/main.py..."
            python src/main.py
          else
            echo "main.py não encontrado, pulando etapa."
          fi

      # ========================
      # 3️⃣ Commit e push StatusModeration
      # ========================
      - name: Commit e push StatusModeration
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "actions-user"
          git add StatusModeration.json StatusModeration.txt || true
          git commit -m "Atualização automática StatusModeration $(date '+%d/%m/%Y %H:%M')" || echo "Nenhuma mudança para commitar"
          git push

      # ========================
      # 4️⃣ Rodar analisar_status_moderation.py (gera e-mail de pendentes)
      # ========================
      - name: Rodar analisar_status_moderation.py (gera e-mail de pendentes)
        run: |
          if [ -f "src/analisar_status_moderation.py" ]; then
            echo "Executando src/analisar_status_moderation.py..."
            python src/analisar_status_moderation.py
          else
            echo "analisar_status_moderation.py não encontrado, pulando etapa."
          fi

      # ========================
      # 5️⃣ Commit e push Clientes_Pendentes.txt
      # ========================
      - name: Commit e push Clientes_Pendentes.txt
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "actions-user"
          git add Clientes_Pendentes.txt
          git commit -m "Atualização automática Clientes_Pendentes $(date '+%d/%m/%Y %H:%M')" || echo "Nenhuma mudança para commitar"
          git push

      # ========================
      # 6️⃣ Commit e push log_execucao_moderation.log
      # ========================
      - name: Commit e push log_execucao_moderation.log
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "actions-user"
          if [ -f "log_execucao_moderation.log" ]; then
            git add log_execucao_moderation.log
            git commit -m "Atualização automática log_execucao_moderation $(date '+%d/%m/%Y %H:%M')" || echo "Nenhuma mudança para commitar"
            git push
          else
            echo "Arquivo log_execucao_moderation.log não encontrado, pulando commit."
          fi

      # ========================
      # 7️⃣ Upload artifact (para debug manual no GitHub)
      # ========================
      - name: Upload artifact (debug)
        uses: actions/upload-artifact@v4
        with:
          name: arquivos_debug
          path: |
            StatusModeration.json
            Clientes_Pendentes.txt
            log_execucao_moderation.log
            src/Clientes_Pendentes.xlsx

      # ========================
      # 8️⃣ Encerramento
      # ========================
      - name: Post Set up Python
        run: echo "Finalizando ambiente Python..."

      - name: Post Checkout
        run: echo "Processo de commit e push finalizado."

      - name: Complete job
        run: echo "✅ Rotina de automação Opthub finalizada com sucesso!"
